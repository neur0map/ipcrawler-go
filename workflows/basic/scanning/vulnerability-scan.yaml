name: "Vulnerability Detection Scan"
description: "Advanced vulnerability scanning using nuclei templates to find CVEs, exposures, and misconfigurations"
parallel_group: "analysis"
requires:
  - "port-discovery"
report:
  enabled: true
  agents:
    - receiver
    - nmap_processor
    - universal_processor
    - validator
    - reporter
steps:
  - tool: "nuclei"
    args_sudo:
      - "-u"                    # Target URL
      - "{{target_urls}}"       # Converted from discovered_ports to URLs
      - "-t"                    # Templates to use
      - "cves/,exposures/,vulnerabilities/,misconfiguration/,default-logins/,network/"
      - "-j"                    # JSON output format
      - "-o"                    # Output file
      - "{{report_dir}}/raw/nuclei_vulnerability_scan_{{target}}.json"
      - "-stats"                # Show statistics
      - "-silent"               # Reduce output noise
      - "-rate-limit"           # Requests per second
      - "200"                   # Higher rate with sudo
      - "-c"                    # Concurrent templates
      - "25"                    # Higher concurrency with sudo
      - "-timeout"              # Request timeout
      - "15"                    # Longer timeout for comprehensive checks
      - "-retries"              # Retry attempts
      - "3"                     # More retries for thorough scanning
      - "-include-tags"         # Include additional checks with sudo
      - "intrusive"             # Include intrusive tests with sudo
    args_normal:
      - "-u"                    # Target URL
      - "{{target_urls}}"       # Converted from discovered_ports to URLs
      - "-t"                    # Templates to use
      - "cves/,exposures/,vulnerabilities/,misconfiguration/,default-logins/"
      - "-j"                    # JSON output format
      - "-o"                    # Output file
      - "{{report_dir}}/raw/nuclei_vulnerability_scan_{{target}}.json"
      - "-stats"                # Show statistics
      - "-silent"               # Reduce output noise
      - "-rate-limit"           # Requests per second
      - "150"                   # Conservative rate limiting
      - "-c"                    # Concurrent templates
      - "15"                    # Balanced concurrency
      - "-timeout"              # Request timeout
      - "10"                    # 10 second timeout
      - "-retries"              # Retry attempts
      - "2"                     # 2 retries for failed requests
      - "-exclude-tags"         # Avoid overlapping with nmap
      - "dos,brute-force,fuzz,intrusive"  # Exclude heavy/noisy templates